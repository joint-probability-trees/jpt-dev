name: Run tests and build the Python distribution

on:
  push:
    branches:
      - main

    tags:
      - "!**"

  workflow_call:
    inputs:
      version:
        required: true
        type: string


defaults:
  run:
    shell: bash
    working-directory: .

jobs:
    build-and-publish:
      name: Build and Test the Python distribution
      runs-on: ubuntu-22.04
      steps:
          - name: Checkout ğŸ›
            uses: actions/checkout@v3

          - name: Setup python ğŸ
            uses: actions/setup-python@v4
            with:
                python-version: 3.8
                cache: pip

          - name: Setup Graphviz ğŸ“Š
            uses: ts-graphviz/setup-graphviz@v1

          - name: Install user dependencies ğŸ¼
            uses: py-actions/py-dependency-install@v4
            with:
              path: "requirements.txt"

          - name: Install developer dependencies ğŸ“
            uses: py-actions/py-dependency-install@v4
            with:
              path: "requirements-dev.txt"

          - name: Create .version file if necessary ğŸ”¢
            if: "${{ github.event.inputs.version != '' }}"
            run: |
              echo "${{ github.event.inputs.version }}" > ../src/jpt/.version

          - name: Run Tests ğŸ“
            run: |
              cd test
              PYTHONPATH=../src python -m unittest discover

          - name: Build binary wheels ğŸ”¨
            uses: RalfG/python-wheels-manylinux-build@v0.7.1
            with:
              python-versions: 'cp38-cp38 cp39-cp39 cp310-cp310 cp311-cp311'
              build-requirements: 'cython numpy'
              pip-wheel-args: '-w ./dist-raw --no-deps'

          - name: Move binary wheels to dist  ğŸ”§
            run: |
              mkdir dist/
              cp dist-raw/*manylinux*.whl dist/

          - name: Install Sphinx dependencies ğŸ“š
            uses: py-actions/py-dependency-install@v4
            with:
              path: "doc/requirements.txt"

          - name: Build Sphinx documentation ğŸ“
            working-directory: ./doc
            run: |
              sudo apt install pandoc
              make html
